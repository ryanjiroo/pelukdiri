<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="dicoding:email" content="bagusasp01@gmail.com">
    <title>MentalMate - Kesehatan Mental</title>
    <link rel="icon" href="{{ url_for('static', filename='icon.png') }}" type="image/png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <style>
        .chat-messages-container {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 8px;
            background-color: #f9f9f9;
            display: flex;
            flex-direction: column;
        }
        .chat-message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 18px;
            max-width: 80%;
            word-wrap: break-word;
        }
        .chat-message.sent {
            background-color: #dcf8c6;
            margin-left: auto;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }
        .chat-message.received {
            background-color: #ffffff;
            border: 1px solid #eee;
            margin-right: auto;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }
        .chat-message.system {
            background-color: #fffbe6;
            color: #7b5b0d;
            border: 1px solid #ffe58f;
            align-self: center;
            text-align: center;
            font-style: italic;
            font-size: 0.85rem;
            max-width: 95%;
            width: auto;
        }
        .chat-message .sender-name {
            font-weight: 600;
            font-size: 0.8rem;
            margin-bottom: 3px;
            color: #3f51b5;
        }
         .chat-message .message-text {
            font-size: 0.95rem;
        }
        .chat-message .timestamp {
            font-size: 0.7rem;
            color: #999;
            margin-top: 4px;
            text-align: right;
        }
        .group-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .group-card-body.clickable:hover {
             background-color: #f8f9fa;
             cursor: pointer;
        }
        .group-card .dropdown-toggle::after {
            display: none;
        }
    </style>
</head>
<body>

    <div id="loadingOverlay" class="loading-overlay d-none">
        <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <nav class="navbar navbar-expand-lg navbar-dark bg-primary-custom sticky-top">
        <div class="container">
          <a class="navbar-brand" href="{{ url_for('index') }}">MentalMate</a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
              <li class="nav-item">
                <a class="nav-link" href="{{ url_for('index') }}">Beranda</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="{{ url_for('index') }}#fitur">Fitur</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="{{ url_for('index') }}#manfaat">Manfaat</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#chatbotModal">Chatbot</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="{{ url_for('blog') }}">Blog</a>
              </li>
              <li class="nav-item">
                <a class="nav-link active" href="{{ url_for('checkin') }}">Checkin</a>
              </li>
              <li class="nav-item d-none" id="logoutNavButtonContainer"> <button id="logoutButton" class="btn btn-outline-light ms-lg-2 mt-2 mt-lg-0">Logout</button>
              </li>
            </ul>
          </div>
        </div>
    </nav>

    <main class="container-fluid mt-4 p-3 p-md-4">
        <div id="messageArea" class="mb-4"></div>

        <div class="row justify-content-center">
            <div class="col-md-8 col-lg-5">
                <section id="authSection" class="auth-card p-4 p-md-5">
                    <div id="loginView">
                        <h2 class="fs-2 fw-bold mb-4 text-center text-primary-custom">Login</h2>
                        <form id="loginForm">
                            <div class="mb-3">
                                <label for="loginUsername" class="form-label small fw-medium mb-1" style="color: var(--dark-text);">Username</label>
                                <input type="text" id="loginUsername" name="username" required class="form-control themed-input">
                            </div>
                            <div class="mb-4">
                                <label for="loginPassword" class="form-label small fw-medium mb-1" style="color: var(--dark-text);">Password</label>
                                <input type="password" id="loginPassword" name="password" required class="form-control themed-input">
                            </div>
                            <button type="submit" class="w-100 btn btn-primary-custom fw-semibold py-2 rounded">Login</button>
                        </form>
                        <p class="mt-4 text-center small">
                            Belum punya akun? <button id="showRegisterButton" class="btn btn-link text-secondary-custom p-0 align-baseline fw-medium">Daftar di sini</button>
                        </p>
                    </div>

                    <div id="registerView" class="d-none">
                        <h2 class="fs-2 fw-bold mb-4 text-center text-primary-custom">Register</h2>
                        <form id="registerForm">
                            <div class="mb-3">
                                <label for="registerUsername" class="form-label small fw-medium mb-1" style="color: var(--dark-text);">Username</label>
                                <input type="text" id="registerUsername" name="username" required class="form-control themed-input">
                            </div>
                             <div class="mb-3">
                                <label for="registerPhone" class="form-label small fw-medium mb-1" style="color: var(--dark-text);">Nomor Telepon</label>
                                <input type="number" id="registerPhone" name="phone" required class="form-control themed-input">
                            </div>
                            <div class="mb-4">
                                <label for="registerPassword" class="form-label small fw-medium mb-1" style="color: var(--dark-text);">Password</label>
                                <input type="password" id="registerPassword" name="password" required class="form-control themed-input">
                            </div>
                            <button type="submit" class="w-100 btn btn-secondary-custom fw-semibold py-2 rounded">Register</button>
                        </form>
                        <p class="mt-4 text-center small">
                            Sudah punya akun? <button id="showLoginButton" class="btn btn-link text-secondary-custom p-0 align-baseline fw-medium">Login di sini</button>
                        </p>
                    </div>
                </section>
            </div>
        </div>

        <div class="row justify-content-center mt-4">
            <div class="col-md-10 col-lg-8">
                <section id="appContentSection" class="d-none app-content-card p-4 p-md-5">
                    <h2 class="fs-2 fw-bold mb-2 text-center text-primary-custom">Daily Check-in</h2>
                    <p id="welcomeMessage" class="text-center mb-3" style="color: var(--dark-text);"></p>

                    <div class="feature-description text-center mb-4">
                         <p class="mb-1">Selamat datang di halaman Daily Check-in! Di sini Anda dapat:</p>
                         <ul class="list-unstyled mb-0">
                             <li>üìù Mencatat perasaan dan kondisi mental Anda setiap hari.</li>
                             <li>üí° Mendapatkan rekomendasi aktivitas positif yang disesuaikan.</li>
                             <li>üìä Melihat riwayat check-in Anda untuk memantau perkembangan.</li>
                             <li>üí¨ Mengobrol dengan teman-teman di grup dukungan Anda.</li>
                             <li>üë§ Mengubah profil Anda.</li>
                         </ul>
                    </div>

                    <div class="text-center mb-4 d-flex flex-wrap justify-content-center gap-2">
                        <button id="showCheckinViewButton" class="btn btn-primary-custom btn-sm"><i class="fas fa-home me-1"></i> Beranda Checkin</button>
                        <button id="showGroupViewButton" class="btn btn-outline-primary-custom btn-sm"><i class="fas fa-users me-1"></i> Grup & Chat</button>
                        <button id="showEditProfileButton" class="btn btn-outline-primary-custom btn-sm"><i class="fas fa-user-edit me-1"></i> Edit Profil</button>
                    </div>

                    <!-- VIEW: Check-in Utama -->
                    <div id="checkInMainView">
                        <div id="checkInFormView">
                            <form id="checkInForm" class="mb-4">
                                <div class="mb-3">
                                    <label for="mood" class="form-label small fw-medium mb-1" style="color: var(--dark-text);">Bagaimana perasaanmu hari ini?</label>
                                    <select id="mood" name="mood" required class="form-select themed-select">
                                        <option value="baik">Baik üòä</option>
                                        <option value="sedang">Sedang üòê</option>
                                        <option value="buruk">Buruk üòü</option>
                                    </select>
                                </div>
                                <div class="mb-4">
                                    <label for="description" class="form-label small fw-medium mb-1" style="color: var(--dark-text);">Ceritakan lebih lanjut (opsional):</label>
                                    <textarea id="description" name="description" rows="3" class="form-control themed-textarea"></textarea>
                                </div>
                                <button type="submit" class="btn btn-success-custom fw-semibold py-2 rounded btn-checkin-submit">Kirim Check-in</button>
                            </form>
                        </div>
                        <div class="d-grid gap-3 d-sm-flex justify-content-sm-center mb-5">
                            <button id="getRecommendationButton" class="btn btn-primary-custom fw-semibold py-2 rounded flex-sm-fill">Dapatkan Rekomendasi</button>
                            <button id="getHistoryButton" class="btn btn-secondary-custom fw-semibold py-2 rounded flex-sm-fill">Riwayat Check-in</button>
                        </div>
                    </div>

                    <!-- VIEW: Edit Profil -->
                    <div id="editProfileView" class="d-none">
                        <h3 class="fs-5 fw-semibold mb-3 text-primary-custom">Edit Profil</h3>
                        <form id="editProfileForm">
                            <div class="mb-3">
                                <label for="editUsername" class="form-label small fw-medium">Username Baru</label>
                                <input type="text" id="editUsername" class="form-control themed-input">
                            </div>
                             <div class="mb-3">
                                <label for="editPhone" class="form-label small fw-medium">Nomor Telepon Baru</label>
                                <input type="number" id="editPhone" class="form-control themed-input">
                            </div>
                            <div class="mb-3">
                                <label for="editPassword" class="form-label small fw-medium">Password Baru</label>
                                <input type="password" id="editPassword" class="form-control themed-input" placeholder="Kosongkan jika tidak ingin diubah">
                                <div class="form-text small">Password baru harus berbeda dari password saat ini.</div>
                            </div>
                            <div class="d-flex justify-content-end gap-2">
                                <button type="button" id="cancelEditProfileButton" class="btn btn-outline-secondary btn-sm">Batal</button>
                                <button type="submit" class="btn btn-primary-custom btn-sm">Simpan Perubahan</button>
                            </div>
                        </form>
                    </div>

                    <!-- VIEW: Grup (Manajemen & List) -->
                    <div id="groupView" class="d-none">
                        <h3 class="fs-5 fw-semibold mb-3 text-primary-custom">Grup Saya</h3>
                        <p class="small text-muted mb-3">Klik pada sebuah grup untuk memulai obrolan. Gunakan menu titik tiga untuk opsi lainnya.</p>
                        <div id="groupList" class="mb-4"></div>

                        <div id="createGroupView" class="mb-4">
                             <h4 class="fs-6 fw-semibold mb-3 text-primary-custom">Buat Grup Baru</h4>
                             <form id="createGroupForm">
                                 <div class="input-group">
                                     <input type="text" id="groupName" class="form-control themed-input" placeholder="Nama Grup Baru" required>
                                     <button type="submit" class="btn btn-success-custom">Buat</button>
                                 </div>
                             </form>
                         </div>
                    </div>
                    
                    <!-- VIEW: Chat Grup -->
                    <div id="groupChatView" class="d-none">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h3 class="fs-5 fw-semibold text-primary-custom mb-0" id="groupChatTitle"></h3>
                            <button id="backToGroupsButton" class="btn btn-outline-secondary btn-sm">
                                <i class="fas fa-arrow-left me-1"></i> Kembali ke Grup
                            </button>
                        </div>
                        <div id="chatMessagesContainer" class="chat-messages-container mb-3">
                            <!-- Pesan akan ditambahkan di sini oleh JavaScript -->
                        </div>
                        <form id="groupChatForm">
                            <input type="hidden" id="chatGroupId">
                            <div class="input-group">
                                <input type="text" id="chatMessageInput" class="form-control themed-input" placeholder="Ketik pesan..." required autocomplete="off">
                                <button class="btn btn-primary-custom" type="submit"><i class="fas fa-paper-plane"></i></button>
                            </div>
                        </form>
                    </div>

                    <!-- VIEW: Rekomendasi -->
                    <div id="recommendationView" class="d-none mt-4 recommendation-view">
                        <h3 class="fs-5 fw-semibold mb-3 text-primary-custom">Rekomendasi Aktivitas</h3>
                        <div id="recommendationText" style="color: var(--dark-text);"></div>
                    </div>

                    <!-- VIEW: Riwayat -->
                    <div id="historyView" class="d-none mt-4">
                        <h3 class="fs-5 fw-semibold mb-3 text-primary-custom">Riwayat Check-in Anda</h3>
                        <div id="historyList" class="d-grid gap-3"></div>
                    </div>
                </section>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <div class="row">
                <div class="col-md-6 text-center text-md-start mb-3 mb-md-0">
                <h3 class="mb-3">MentalMate</h3>
                <p>Teman virtual untuk kesehatan mental yang lebih baik.</p>
                </div>
                <div class="col-md-6 text-center text-md-end">
                <p>¬© 2025 MentalMate. Hak Cipta Dilindungi.</p>
                <p>Dibuat dengan <i class="fas fa-heart text-accent-custom"></i> untuk kesehatan mental yang lebih baik.</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- MODAL UTAMA -->
    <div id="customModal" class="custom-modal d-none">
        <div class="custom-modal-content">
            <h3 id="modalTitle" class="fs-5 fw-bold mb-3">Pemberitahuan</h3>
            <div id="modalMessage" class="mb-4" style="color: var(--dark-text);"></div>
            <div id="modalActionButtons" class="d-flex gap-2">
                 <button class="w-100 btn btn-primary-custom fw-semibold py-2 rounded modal-close-button">Tutup</button>
            </div>
        </div>
    </div>

    <!-- MODAL KHUSUS EDIT GRUP -->
    <div id="editGroupModal" class="modal fade" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Nama Grup</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editGroupFormModal">
                        <input type="hidden" id="editGroupIdInput">
                        <div class="mb-3">
                            <label for="editGroupNameInput" class="form-label">Nama Grup Baru</label>
                            <input type="text" class="form-control" id="editGroupNameInput" required>
                        </div>
                         <button type="submit" class="btn btn-primary-custom w-100">Simpan</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL KHUSUS KELOLA ANGGOTA -->
    <div id="manageMembersModal" class="modal fade" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="manageMembersModalTitle">Kelola Anggota</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addMemberFormInModal" class="mb-4">
                         <h6 class="fs-6">Tambah Anggota</h6>
                         <input type="hidden" id="addMemberModalGroupId">
                         <div class="input-group">
                             <input type="text" id="addMemberModalUsername" class="form-control themed-input" placeholder="Username Anggota" required>
                             <button type="submit" class="btn btn-success-custom">Tambah</button>
                         </div>
                    </form>
                    <h6 class="fs-6">Daftar Anggota</h6>
                    <ul id="memberList" class="list-group">
                        <!-- Daftar anggota akan diisi oleh JavaScript -->
                    </ul>
                </div>
            </div>
        </div>
    </div>


    <div class="modal fade" id="chatbotModal" tabindex="-1" aria-labelledby="chatbotModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header chat-header">
            <div class="chat-header-icon">
              <i class="fas fa-comment-dots"></i>
            </div>
            <div>
              <h5 class="modal-title" id="chatbotModalLabel">MentalMate Chatbot</h5>
              <small>Online</small>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="chat-box" id="chat-box">
              <div class="chat-message ai-message">
                <strong>MentalMate:</strong> Halo! Saya MentalMate, asisten kesehatan mental virtualmu. Bagaimana perasaanmu hari ini? Ada yang bisa saya bantu?
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <div class="chat-input-container">
              <textarea class="chat-input" id="user-input" placeholder="Ketik pesanmu di sini..." rows="1"></textarea>
              <button class="btn btn-secondary-custom chat-send-btn" id="send-button">
                <i class="fas fa-paper-plane"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

    <script>
        // --- Konfigurasi API ---
        const API_BASE_URL = 'http://localhost:3000/api';

        // --- Referensi Elemen DOM ---
        const loadingOverlay = document.getElementById('loadingOverlay');
        const authSection = document.getElementById('authSection');
        const appContentSection = document.getElementById('appContentSection');
        const loginView = document.getElementById('loginView');
        const registerView = document.getElementById('registerView');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');

        // Main App Views
        const checkInMainView = document.getElementById('checkInMainView');
        const editProfileView = document.getElementById('editProfileView');
        const groupView = document.getElementById('groupView');
        const groupChatView = document.getElementById('groupChatView');
        const recommendationView = document.getElementById('recommendationView');
        const historyView = document.getElementById('historyView');
        
        const welcomeMessage = document.getElementById('welcomeMessage');
        const logoutButton = document.getElementById('logoutButton');
        const logoutNavButtonContainer = document.getElementById('logoutNavButtonContainer');

        // Navigasi
        const showRegisterButton = document.getElementById('showRegisterButton');
        const showLoginButton = document.getElementById('showLoginButton');
        const showCheckinViewButton = document.getElementById('showCheckinViewButton');
        const showGroupViewButton = document.getElementById('showGroupViewButton');
        const showEditProfileButton = document.getElementById('showEditProfileButton');

        // Checkin
        const checkInForm = document.getElementById('checkInForm');
        const getRecommendationButton = document.getElementById('getRecommendationButton');
        const recommendationText = document.getElementById('recommendationText');
        const getHistoryButton = document.getElementById('getHistoryButton');
        const historyList = document.getElementById('historyList');

        // Edit Profil
        const editProfileForm = document.getElementById('editProfileForm');
        const editUsernameInput = document.getElementById('editUsername');
        const editPhoneInput = document.getElementById('editPhone');
        const editPasswordInput = document.getElementById('editPassword');
        const cancelEditProfileButton = document.getElementById('cancelEditProfileButton');

        // Grup & Chat
        const groupList = document.getElementById('groupList');
        const createGroupForm = document.getElementById('createGroupForm');
        const groupNameInput = document.getElementById('groupName');
        const backToGroupsButton = document.getElementById('backToGroupsButton');
        const groupChatTitle = document.getElementById('groupChatTitle');
        const chatMessagesContainer = document.getElementById('chatMessagesContainer');
        const groupChatForm = document.getElementById('groupChatForm');
        const chatGroupIdInput = document.getElementById('chatGroupId');
        const chatMessageInput = document.getElementById('chatMessageInput');

        // Modal Notifikasi & Konfirmasi
        const customModal = document.getElementById('customModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalActionButtons = document.getElementById('modalActionButtons');
        
        // Modal Edit Grup
        const editGroupModal = new bootstrap.Modal(document.getElementById('editGroupModal'));
        const editGroupFormModal = document.getElementById('editGroupFormModal');
        const editGroupIdInput = document.getElementById('editGroupIdInput');
        const editGroupNameInput = document.getElementById('editGroupNameInput');

        // Modal Kelola Anggota
        const manageMembersModalEl = document.getElementById('manageMembersModal');
        const manageMembersModal = new bootstrap.Modal(manageMembersModalEl);
        const manageMembersModalTitle = document.getElementById('manageMembersModalTitle');
        const memberList = document.getElementById('memberList');
        const addMemberFormInModal = document.getElementById('addMemberFormInModal');
        const addMemberModalGroupIdInput = document.getElementById('addMemberModalGroupId');
        const addMemberModalUsernameInput = document.getElementById('addMemberModalUsername');


        // --- State Aplikasi ---
        let currentUserToken = null;
        let currentUsername = null;
        let currentUserId = null;
        let currentUserPhone = null; // DIUBAH: Tambahkan state untuk nomor telepon
        let socket = null;
        let myGroups = []; // Cache group data

        // --- Fungsi Loading & Modal ---
        function showLoading() { if (loadingOverlay) loadingOverlay.classList.remove('d-none'); }
        function hideLoading() { if (loadingOverlay) loadingOverlay.classList.add('d-none'); }
        
        function showCustomModal(title, messageHtml) {
            modalTitle.textContent = title;
            modalMessage.innerHTML = messageHtml;
            modalActionButtons.innerHTML = `<button class="modal-close-button w-100 btn btn-primary-custom fw-semibold py-2 rounded">Tutup</button>`;
            customModal.classList.remove('d-none');
            document.querySelector('.modal-close-button').addEventListener('click', () => customModal.classList.add('d-none'));
        }

        function showConfirmationModal(title, messageHtml, onConfirm, onCancel = () => {}) {
            modalTitle.textContent = title;
            modalMessage.innerHTML = messageHtml;
            modalActionButtons.innerHTML = `
                <button id="confirmCancelButton" class="w-50 btn btn-outline-secondary">Batal</button>
                <button id="confirmActionButton" class="w-50 btn btn-danger">Ya, Lanjutkan</button>
            `;
            customModal.classList.remove('d-none');

            document.getElementById('confirmActionButton').addEventListener('click', () => {
                customModal.classList.add('d-none');
                onConfirm();
            });
            document.getElementById('confirmCancelButton').addEventListener('click', () => {
                 customModal.classList.add('d-none');
                 onCancel();
            });
        }
        
        function displayMessage(message, type = 'success') {
            modalTitle.textContent = type === 'success' ? 'Sukses' : 'Error';
            modalMessage.innerHTML = `<p>${message}</p>`;
            modalTitle.className = `fs-5 fw-bold mb-3 ${type === 'error' ? 'text-danger' : 'text-primary-custom'}`;
            modalActionButtons.innerHTML = `<button class="modal-close-button w-100 btn btn-primary-custom fw-semibold py-2 rounded">Tutup</button>`;
            customModal.classList.remove('d-none');
            document.querySelector('.modal-close-button').addEventListener('click', () => customModal.classList.add('d-none'));
        }

        // --- Navigasi View ---
        function showView(viewToShow) {
            const views = [checkInMainView, editProfileView, groupView, groupChatView, recommendationView, historyView];
            views.forEach(view => { if (view) view.classList.add('d-none'); });
            if (viewToShow) viewToShow.classList.remove('d-none');
        }

        // --- Panggilan API ---
        async function apiCall(endpoint, method = 'GET', body = null, requiresAuth = true) {
            showLoading();
            const headers = { 'Content-Type': 'application/json' };
            if (requiresAuth && currentUserToken) { headers['Authorization'] = `Bearer ${currentUserToken}`; }
            const config = { method, headers };
            if (body) config.body = JSON.stringify(body);
            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, config);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: response.statusText }));
                    throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
                }
                // DIUBAH: Mengembalikan data JSON bahkan jika responsnya bukan 200 OK untuk login
                // yang mungkin mengembalikan user data bersama token.
                if (method === 'POST' && endpoint.includes('login')) {
                    return await response.json();
                }
                return response.status === 204 ? null : await response.json();
            } catch (error) {
                console.error('API Call Error:', error);
                displayMessage(`Error: ${error.message}`, 'error');
                throw error;
            } finally {
                hideLoading();
            }
        }

        // --- Update UI & Socket ---
        function updateUIForAuthState() {
            const isLoggedIn = !!currentUserToken;
            authSection.classList.toggle('d-none', isLoggedIn);
            appContentSection.classList.toggle('d-none', !isLoggedIn);
            logoutNavButtonContainer.classList.toggle('d-none', !isLoggedIn);
            if (isLoggedIn) {
                welcomeMessage.textContent = `Selamat datang kembali, ${currentUsername}!`;
                showView(checkInMainView);
                connectSocket();
            } else {
                loginView.classList.remove('d-none');
                registerView.classList.add('d-none');
                welcomeMessage.textContent = '';
                if(socket) { socket.disconnect(); socket = null; }
            }
        }

        function connectSocket() {
             if (socket || !currentUserId) return;
             socket = io("http://localhost:3000");
             socket.on('connect', () => {
                 console.log('Connected to Socket.IO server with id:', socket.id);
                 socket.emit('registerUser', currentUserId);
                 if (myGroups.length > 0) {
                     socket.emit('joinGroupRooms', myGroups.map(g => g._id));
                 }
             });
             
             socket.on('newGroupMessage', (message) => {
                 if (groupChatView.classList.contains('d-none') === false && chatGroupIdInput.value === message.groupId) {
                    appendMessage(message);
                 }
                 if (message.isSupportAlert && message.sender !== currentUserId) {
                     let messageHtml = `<p>Halo, temanmu <b>${message.fromUser}</b> di grup ini sepertinya ${message.reasonForAlert}. Mungkin kamu bisa menyapanya?</p>`;
                     if (message.supportUrl) {
                         messageHtml += `<a href="${message.supportUrl}" target="_blank" class="btn btn-success-custom w-100 mb-2"><i class="fab fa-whatsapp"></i> Sapa ${message.fromUser} di WhatsApp</a>`;
                     }
                     showCustomModal('Butuh Dukungan Teman', messageHtml);
                 }
             });

             socket.on('disconnect', () => { console.log('Disconnected from Socket.IO server'); });
        }
        
        // --- Fungsi Autentikasi ---
        function parseJwt(token) { try { return JSON.parse(atob(token.split('.')[1])); } catch (e) { return null; } }
        
        // DIUBAH: Event listener untuk login
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                // Asumsikan API login sekarang mengembalikan { token, user: { username, phone, id } }
                const data = await apiCall('/auth/login', 'POST', { username: e.target.username.value, password: e.target.password.value }, false);
                if (data && data.token) {
                    currentUserToken = data.token;
                    const decodedToken = parseJwt(data.token);
                    currentUserId = decodedToken ? decodedToken.id : null;

                    // Ambil data user dari respons
                    if (data.user) {
                        currentUsername = data.user.username;
                        currentUserPhone = data.user.phone;
                    } else {
                        // Fallback jika API tidak mengembalikan objek user
                        currentUsername = e.target.username.value;
                        currentUserPhone = null;
                    }
                    
                    // Simpan semua data ke session storage
                    sessionStorage.setItem('authToken', currentUserToken);
                    sessionStorage.setItem('username', currentUsername);
                    sessionStorage.setItem('userId', currentUserId);
                    if (currentUserPhone) {
                        sessionStorage.setItem('userPhone', currentUserPhone);
                    } else {
                        sessionStorage.removeItem('userPhone');
                    }

                    updateUIForAuthState();
                    displayMessage('Login berhasil!');
                }
            } catch (error) { /* Ditangani di apiCall */ }
        });
        
        // DIUBAH: Event listener untuk logout
        logoutButton.addEventListener('click', () => {
            currentUserToken = null;
            currentUsername = null;
            currentUserId = null;
            currentUserPhone = null; // Hapus data telepon saat logout
            myGroups = [];
            sessionStorage.clear();
            updateUIForAuthState();
            displayMessage('Anda telah logout.');
        });
        
        // --- Navigasi View & Form Toggle ---
        showRegisterButton.addEventListener('click', () => { loginView.classList.add('d-none'); registerView.classList.remove('d-none'); });
        showLoginButton.addEventListener('click', () => { registerView.classList.add('d-none'); loginView.classList.remove('d-none'); });
        showCheckinViewButton.addEventListener('click', () => showView(checkInMainView));
        
        // DIUBAH: Event listener untuk menampilkan form edit profil
        showEditProfileButton.addEventListener('click', () => {
            showView(editProfileView);
            editUsernameInput.value = currentUsername;
            editPasswordInput.value = ''; // Selalu kosongkan field password

            // Cek apakah ada nomor telepon yang tersimpan
            if (currentUserPhone) {
                editPhoneInput.value = currentUserPhone;
                editPhoneInput.placeholder = ''; // Hapus placeholder jika ada data
            } else {
                editPhoneInput.value = '';
                // Tampilkan placeholder jika tidak ada data telepon
                editPhoneInput.placeholder = 'Kosongkan jika tidak ingin diisi';
            }
        });

        showGroupViewButton.addEventListener('click', () => { showView(groupView); fetchMyGroups(); });
        cancelEditProfileButton.addEventListener('click', () => showView(checkInMainView));
        backToGroupsButton.addEventListener('click', () => { showView(groupView); fetchMyGroups(); });

        // --- Fungsi Grup & Chat ---
        async function fetchMyGroups() {
            if (!currentUserToken) return;
            try {
                const data = await apiCall('/groups/my-groups');
                groupList.innerHTML = '';
                if (data && data.groups) {
                    myGroups = data.groups;
                    if(socket && socket.connected) socket.emit('joinGroupRooms', myGroups.map(g => g._id));
                    
                    if(myGroups.length > 0) {
                        myGroups.forEach(group => {
                            const isCreator = group.creator._id === currentUserId;
                            const membersList = group.members.map(m => m.username === currentUsername ? `<b>${m.username} (Anda)</b>` : m.username).join(', ');
                            
                            let dropdownMenu = '';
                            if (isCreator) {
                                dropdownMenu = `
                                    <li><a class="dropdown-item edit-group-btn" href="#" data-group-id="${group._id}" data-group-name="${group.name}">Edit Grup</a></li>
                                    <li><a class="dropdown-item manage-members-btn" href="#" data-group-id="${group._id}">Kelola Anggota</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item text-danger delete-group-btn" href="#" data-group-id="${group._id}" data-group-name="${group.name}">Hapus Grup</a></li>
                                `;
                            } else {
                                dropdownMenu = `<li><a class="dropdown-item text-danger leave-group-btn" href="#" data-group-id="${group._id}" data-group-name="${group.name}">Keluar dari Grup</a></li>`;
                            }

                            const groupCard = document.createElement('div');
                            groupCard.className = 'card mb-3 group-card';
                            groupCard.innerHTML = `
                                <div class="card-body d-flex justify-content-between align-items-center">
                                    <div class="group-card-body clickable flex-grow-1" data-group-id="${group._id}" data-group-name="${group.name}">
                                        <h5 class="card-title mb-1">${group.name}</h5>
                                        <h6 class="card-subtitle mb-2 text-muted small">Dibuat oleh: ${group.creator.username}</h6>
                                        <p class="card-text small mb-0">Anggota: ${membersList}</p>
                                    </div>
                                    <div class="dropdown">
                                        <button class="btn btn-light btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                            <i class="fas fa-ellipsis-v"></i>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end">
                                            ${dropdownMenu}
                                        </ul>
                                    </div>
                                </div>`;
                            groupList.appendChild(groupCard);
                        });
                    } else {
                        groupList.innerHTML = '<p>Anda belum bergabung dengan grup manapun.</p>';
                    }
                }
            } catch (error) { groupList.innerHTML = '<p class="text-danger">Gagal memuat grup.</p>'; }
        }
        
        createGroupForm.addEventListener('submit', async (e) => { e.preventDefault(); const name = groupNameInput.value.trim(); if (!name) return; try { await apiCall('/groups', 'POST', { name }); displayMessage('Grup berhasil dibuat!'); groupNameInput.value = ''; fetchMyGroups(); } catch (error) { /* Ditangani di apiCall */ } });
        
        groupList.addEventListener('click', (e) => {
            const target = e.target;
            const groupCardBody = target.closest('.group-card-body');
            
            if (groupCardBody) { openGroupChat(target.closest('.group-card-body').dataset.groupId, target.closest('.group-card-body').dataset.groupName);
            } else if (target.matches('.edit-group-btn')) { e.preventDefault(); handleEditGroup(target.dataset.groupId, target.dataset.groupName);
            } else if (target.matches('.delete-group-btn')) { e.preventDefault(); handleDeleteGroup(target.dataset.groupId, target.dataset.groupName);
            } else if (target.matches('.leave-group-btn')) { e.preventDefault(); handleLeaveGroup(target.dataset.groupId, target.dataset.groupName);
            } else if (target.matches('.manage-members-btn')) { e.preventDefault(); openManageMembersModal(target.dataset.groupId); }
        });

        function handleEditGroup(groupId, currentName) {
            editGroupIdInput.value = groupId;
            editGroupNameInput.value = currentName;
            editGroupModal.show();
        }
        
        editGroupFormModal.addEventListener('submit', async function(e) {
            e.preventDefault();
            const groupId = editGroupIdInput.value;
            const newName = editGroupNameInput.value.trim();
            if (!newName) return;
            try {
                await apiCall(`/groups/${groupId}`, 'PUT', { name: newName });
                displayMessage('Nama grup berhasil diubah.');
                editGroupModal.hide();
                fetchMyGroups();
            } catch (error) { /* Ditangani di apiCall */ }
        });

        function handleDeleteGroup(groupId, groupName) {
            const message = `<p>Apakah Anda yakin ingin menghapus grup <strong>${groupName}</strong>? Semua riwayat chat akan hilang dan tindakan ini tidak dapat diurungkan.</p>`;
            showConfirmationModal('Konfirmasi Hapus Grup', message, async () => {
                try {
                    await apiCall(`/groups/${groupId}`, 'DELETE');
                    displayMessage('Grup berhasil dihapus.');
                    fetchMyGroups();
                } catch (error) { /* Ditangani di apiCall */ }
            });
        }
        
        function handleLeaveGroup(groupId, groupName) {
            const message = `<p>Apakah Anda yakin ingin keluar dari grup <strong>${groupName}</strong>?</p>`;
            showConfirmationModal('Konfirmasi Keluar Grup', message, async () => {
                try {
                    await apiCall(`/groups/${groupId}/leave`, 'POST');
                    displayMessage('Anda telah keluar dari grup.');
                    fetchMyGroups();
                } catch (error) { /* Ditangani di apiCall */ }
            });
        }

        function renderMemberList(group) {
            memberList.innerHTML = '';
            group.members.forEach(member => {
                const isCreator = member._id === group.creator._id;
                const memberItem = document.createElement('li');
                memberItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                memberItem.innerHTML = `
                    <span><i class="fas fa-user me-2"></i>${member.username} ${isCreator ? '<span class="badge bg-primary-custom ms-2">Creator</span>' : ''}</span>
                    ${!isCreator ? `<button class="btn btn-outline-danger btn-sm remove-member-btn" data-group-id="${group._id}" data-member-id="${member._id}" data-member-name="${member.username}">Keluarkan</button>` : ''}
                `;
                memberList.appendChild(memberItem);
            });
        }
        
        function openManageMembersModal(groupId) {
            const group = myGroups.find(g => g._id === groupId);
            if (!group) return;
            manageMembersModalTitle.textContent = `Kelola Anggota: ${group.name}`;
            addMemberModalGroupIdInput.value = groupId;
            renderMemberList(group);
            manageMembersModal.show();
        }
        
        addMemberFormInModal.addEventListener('submit', async (e) => {
            e.preventDefault();
            const groupId = addMemberModalGroupIdInput.value;
            const username = addMemberModalUsernameInput.value.trim();
            if (!groupId || !username) return;
            try {
                manageMembersModal.hide();
                await apiCall(`/groups/${groupId}/members`, 'POST', { username });
                displayMessage(`Anggota ${username} berhasil ditambahkan!`);
                
                await fetchMyGroups();
                const updatedGroup = myGroups.find(g => g._id === groupId);
                if(updatedGroup) {
                    document.getElementById('customModal').addEventListener('hidden.bs.modal', () => {
                         openManageMembersModal(groupId);
                    }, { once: true });
                }
                
            } catch(error) { 
                document.getElementById('customModal').addEventListener('hidden.bs.modal', () => {
                    manageMembersModal.show();
                }, { once: true });
            }
        });
        
        memberList.addEventListener('click', function(e) {
            if (e.target.matches('.remove-member-btn')) {
                const { groupId, memberId, memberName } = e.target.dataset;
                const message = `<p>Apakah Anda yakin ingin mengeluarkan <strong>${memberName}</strong> dari grup?</p>`;
                
                manageMembersModal.hide();
                
                showConfirmationModal('Konfirmasi Keluarkan Anggota', message, 
                    async () => {
                        try {
                            await apiCall(`/groups/${groupId}/members/${memberId}`, 'DELETE');
                            displayMessage(`${memberName} berhasil dikeluarkan.`);
                            await fetchMyGroups();
                            
                            document.getElementById('customModal').addEventListener('hidden.bs.modal', () => {
                                 openManageMembersModal(groupId);
                            }, { once: true });

                        } catch(error) { 
                            document.getElementById('customModal').addEventListener('hidden.bs.modal', () => {
                                 openManageMembersModal(groupId);
                            }, { once: true });
                        }
                    },
                    () => {
                        manageMembersModal.show();
                    }
                );
            }
        });

        async function openGroupChat(groupId, groupName) {
            showView(groupChatView);
            groupChatTitle.textContent = `Chat Grup: ${groupName}`;
            chatGroupIdInput.value = groupId;
            chatMessagesContainer.innerHTML = '<p class="text-center text-muted">Memuat pesan...</p>';
            try {
                const messages = await apiCall(`/groups/${groupId}/messages`);
                chatMessagesContainer.innerHTML = '';
                messages.forEach(appendMessage);
            } catch (error) {
                chatMessagesContainer.innerHTML = '<p class="text-center text-danger">Gagal memuat pesan.</p>';
            }
        }
        
        function appendMessage(message) {
            const isSystemMessage = message.username === 'Sistem';
            if (isSystemMessage && message.sender === currentUserId) return;
            const messageDiv = document.createElement('div');
            const messageType = isSystemMessage ? 'system' : (message.sender === currentUserId ? 'sent' : 'received');
            messageDiv.className = `chat-message ${messageType}`;
            let sentAt = '';
            if (message.createdAt) { const dateObj = new Date(message.createdAt); if (!isNaN(dateObj.getTime())) sentAt = dateObj.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }); }
            if (isSystemMessage) { messageDiv.innerHTML = `<div class="message-text">${message.text}</div>`;
            } else { messageDiv.innerHTML = ` ${messageType === 'received' ? `<div class="sender-name">${message.username}</div>` : ''} <div class="message-text">${message.text}</div> <div class="timestamp">${sentAt}</div> `; }
            chatMessagesContainer.appendChild(messageDiv);
            chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
        }

        groupChatForm.addEventListener('submit', (e) => { e.preventDefault(); const text = chatMessageInput.value.trim(); const groupId = chatGroupIdInput.value; if (!text || !groupId || !socket) return; const messageData = { groupId, sender: currentUserId, username: currentUsername, text }; socket.emit('sendGroupMessage', messageData); chatMessageInput.value = ''; });

        // --- Fungsi Lainnya ---
        registerForm.addEventListener('submit', async (e) => { e.preventDefault(); try { await apiCall('/auth/register', 'POST', { username: e.target.username.value, password: e.target.password.value, phone: e.target.phone.value }, false); displayMessage('Registrasi berhasil! Silakan login.'); registerForm.reset(); if (showLoginButton) showLoginButton.click(); } catch (error) { /* Ditangani di apiCall */ } });
        
        // DIUBAH: Event listener untuk submit form edit profil
        editProfileForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const newUsername = editUsernameInput.value.trim();
            const newPassword = editPasswordInput.value;
            const newPhone = editPhoneInput.value.trim();
            const body = {};

            // Hanya tambahkan data ke body jika ada perubahan
            if (newUsername && newUsername !== currentUsername) {
                body.username = newUsername;
            }
            if (newPassword) {
                body.password = newPassword;
            }
            if (newPhone !== (currentUserPhone || '')) {
                body.phone = newPhone;
            }

            if (Object.keys(body).length === 0) {
                displayMessage('Tidak ada data yang diubah.', 'error');
                return;
            }

            try {
                // Asumsikan API update mengembalikan data user yang telah diperbarui
                const data = await apiCall('/auth/update-profile', 'PUT', body);
                if (data && data.user) {
                    displayMessage(data.message || 'Profil berhasil diperbarui!');
                    
                    // Perbarui state dan session storage
                    currentUsername = data.user.username;
                    currentUserPhone = data.user.phone;
                    sessionStorage.setItem('username', currentUsername);
                    if (currentUserPhone) {
                        sessionStorage.setItem('userPhone', currentUserPhone);
                    } else {
                        sessionStorage.removeItem('userPhone');
                    }

                    if(welcomeMessage) welcomeMessage.textContent = `Selamat datang kembali, ${currentUsername}!`;
                    showView(checkInMainView);
                }
            } catch (error) { /* Ditangani di apiCall */ }
        });

        checkInForm.addEventListener('submit', async (e) => { e.preventDefault(); try { await apiCall('/checkin', 'POST', { mood: e.target.mood.value, description: e.target.description.value }); displayMessage('Check-in berhasil disimpan!'); checkInForm.reset(); await fetchRecommendation(); showView(recommendationView); } catch (error) { /* Ditangani di apiCall */ } });
        getRecommendationButton.addEventListener('click', async () => { try { await fetchRecommendation(); if (recommendationText && recommendationText.innerHTML && !recommendationText.textContent.includes('Gagal memuat')) { showView(recommendationView); } } catch (error) { /* Ditangani di apiCall */ } });
        getHistoryButton.addEventListener('click', async () => { try { await fetchHistory(); if (historyList && historyList.innerHTML && !historyList.textContent.includes('Gagal memuat')) { showView(historyView); } } catch (error) { /* Ditangani di apiCall */ } });
        async function fetchRecommendation() { if (!currentUserToken) { displayMessage('Anda harus login untuk mendapatkan rekomendasi.', 'error'); if(recommendationText) recommendationText.innerHTML = '<p>Silakan login terlebih dahulu.</p>'; return; } try { const data = await apiCall('/checkin/recommendation'); if (data && data.recommendation) { if(recommendationText && typeof marked !== 'undefined') { recommendationText.innerHTML = marked.parse(data.recommendation); } else if (recommendationText) { recommendationText.textContent = data.recommendation; } } else { if(recommendationText) recommendationText.innerHTML = '<p>Tidak ada rekomendasi terbaru untuk Anda. Silakan lakukan check-in terlebih dahulu.</p>'; } } catch (error) { if(recommendationText) recommendationText.innerHTML = '<p class="text-danger">Gagal memuat rekomendasi.</p>'; } }
        async function fetchHistory() { if (!currentUserToken) { displayMessage('Anda harus login untuk melihat riwayat.', 'error'); if(historyList) historyList.innerHTML = '<p style="color: var(--dark-text);">Silakan login terlebih dahulu.</p>'; return; } try { const data = await apiCall('/checkin'); if(historyList) historyList.innerHTML = ''; if (data && data.length > 0) { data.sort((a, b) => new Date(b.date) - new Date(a.date)); data.forEach(item => { const itemDiv = document.createElement('div'); itemDiv.className = 'history-item'; const moodText = item.mood.charAt(0).toUpperCase() + item.mood.slice(1); let moodEmoji = ''; if (item.mood === 'baik') moodEmoji = 'üòä'; else if (item.mood === 'sedang') moodEmoji = 'üòê'; else if (item.mood === 'buruk') moodEmoji = 'üòü'; itemDiv.innerHTML = ` <p class="fw-semibold mb-1" style="color: var(--dark-text);">Tanggal: <span class="fw-normal">${new Date(item.date).toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour:'2-digit', minute:'2-digit' })}</span></p> <p class="fw-semibold mb-1" style="color: var(--dark-text);">Mood: <span class="fw-normal">${moodText} ${moodEmoji}</span></p> <p class="fw-semibold mb-0" style="color: var(--dark-text);">Deskripsi: <span class="fw-normal">${item.description || '-'}</span></p> `; if(historyList) historyList.appendChild(itemDiv); }); } else { if(historyList) historyList.innerHTML = '<p style="color: var(--dark-text);">Belum ada riwayat check-in.</p>'; } } catch (error) { if(historyList) historyList.innerHTML = '<p class="text-danger">Gagal memuat riwayat check-in.</p>'; } }
        
        // --- Inisialisasi Aplikasi ---
        // DIUBAH: Inisialisasi aplikasi saat DOM dimuat
        window.addEventListener('DOMContentLoaded', () => {
            currentUserToken = sessionStorage.getItem('authToken');
            currentUsername = sessionStorage.getItem('username');
            currentUserId = sessionStorage.getItem('userId');
            currentUserPhone = sessionStorage.getItem('userPhone'); // Ambil data telepon dari session
            updateUIForAuthState();
        });
    </script>
</body>
</html>
